<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TSPL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#e5e7eb;
      margin:0;
    }
    .app{max-width:480px;margin:0 auto;padding:12px;}
    h1{font-size:20px;margin:0 0 8px;}
    .preview-wrap{
      background:#f3f4f6;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      justify-content:center;
    }
    .label{
      width:40mm;
      height:30mm;
      border:2px solid #111827;
      background:white;
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:center;
      padding:1mm 2mm;
      box-sizing:border-box;
      font-size:10pt;
      line-height:1.2;
    }
    .controls input[type="text"]{
      width:100%;
      padding:8px 10px;
      margin-bottom:6px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    .slider-group{
      margin-bottom:12px;
      padding:12px;
      background:white;
      border-radius:8px;
    }
    .slider-group label{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
    }
    .slider{
      width:100%;
      height:6px;
      border-radius:3px;
      outline:none;
    }
    .btn{
      width:100%;
      padding:10px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-bottom:6px;
      color:white;
    }
    .btn-primary{background:#6366f1;}
    .btn-usb{background:#ec4899;}
    .btn-disconnect{background:#f59e0b;}
    .btn-danger{background:#ef4444;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:6px;margin-bottom:6px;}
    .row .btn{flex:1;margin-bottom:0;}
    .status{
      font-size:13px;
      margin-bottom:8px;
      padding:8px;
      background:white;
      border-radius:8px;
    }
    .hint{
      font-size:12px;
      color:#6b7280;
      margin-bottom:8px;
      padding:8px;
      background:#fef3c7;
      border-radius:8px;
    }
    #printArea{display:none;}
    @media print{
      @page{size:40mm 30mm;margin:0;}
      body>*:not(#printArea){display:none!important;}
      #printArea{display:block!important;}
      .print-label{
        width:40mm;
        height:30mm;
        border:2px solid #000;
        box-sizing:border-box;
        padding:0 2mm;
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:center;
        font-size:10pt;
        line-height:1.2;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>üè∑Ô∏è –≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî TSPL</h1>

  <div class="hint">
    üí° –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã. –ü–æ–¥—Å—Ç—Ä–æ–π —Ä–∞–∑–º–µ—Ç–∫—É —Å–ª–∞–π–¥–µ—Ä–∞–º–∏, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º —Ä—É—Å—Å–∫–∏–π.
  </div>

  <div class="preview-wrap">
    <div class="label" id="preview">
      <div class="l1" style="font-size:12pt;font-weight:bold"></div>
      <div class="l2" style="font-size:10pt"></div>
      <div class="l3" style="font-size:10pt"></div>
      <div class="l4" style="font-size:10pt"></div>
      <div class="l5" style="font-size:10pt"></div>
    </div>
  </div>

  <div class="controls">
    <input id="l1" type="text" placeholder="Line 1 (Latin only)" value="SHR-P-1">
    <input id="l2" type="text" placeholder="Line 2" value="Osveshchenie">
    <input id="l3" type="text" placeholder="Line 3" value="VVGng-LSLT 3x1.5">
    <input id="l4" type="text" placeholder="Line 4" value="ot SHR-P">
    <input id="l5" type="text" placeholder="Line 5" value="L=15m">
  </div>

  <div class="slider-group">
    <label>
      <span>üìç Y –Ω–∞—á–∞–ª–æ (–æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É)</span>
      <span id="yStartVal">10</span>
    </label>
    <input type="range" class="slider" id="yStart" min="0" max="50" value="10" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>‚ÜïÔ∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏</span>
      <span id="yStepVal">25</span>
    </label>
    <input type="range" class="slider" id="yStep" min="15" max="40" value="25" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>‚ÜîÔ∏è X –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞</span>
      <span id="xLeftVal">10</span>
    </label>
    <input type="range" class="slider" id="xLeft" min="0" max="50" value="10" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>üîÑ –ü–æ–≤–æ—Ä–æ—Ç (DIRECTION)</span>
      <span id="dirVal">1</span>
    </label>
    <input type="range" class="slider" id="direction" min="0" max="3" value="1" step="1">
  </div>

  <div class="status" id="usbStatus">üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

  <div class="row">
    <button class="btn btn-usb" id="usbConnectBtn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button class="btn btn-disconnect" id="usbDisconnectBtn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å</button>
  </div>
  
  <button class="btn btn-usb" id="usbPrintBtn" disabled>‚ö° –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ USB (TSPL)</button>

  <div class="row">
    <button class="btn btn-primary" id="pdfBtn">üìÑ PDF</button>
    <button class="btn btn-primary" id="pngBtn">üñºÔ∏è PNG</button>
  </div>

  <button class="btn btn-danger" id="printBtn">üñ®Ô∏è –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å</button>

  <div id="printArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let usbDevice=null;
let usbEndpoint=1;

function updatePreview(){
  const p=document.getElementById('preview');
  const lines=p.querySelectorAll('div');
  for(let i=1;i<=5;i++){
    lines[i-1].textContent=document.getElementById('l'+i).value;
  }
}

function updateSliderValues(){
  document.getElementById('yStartVal').textContent=document.getElementById('yStart').value;
  document.getElementById('yStepVal').textContent=document.getElementById('yStep').value;
  document.getElementById('xLeftVal').textContent=document.getElementById('xLeft').value;
  document.getElementById('dirVal').textContent=document.getElementById('direction').value;
}

['l1','l2','l3','l4','l5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updatePreview);
});

['yStart','yStep','xLeft','direction'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updateSliderValues);
});

updatePreview();
updateSliderValues();

// --- TSPL –∫–æ–º–∞–Ω–¥–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ ---
function buildTSPL(){
  const l1=document.getElementById('l1').value;
  const l2=document.getElementById('l2').value;
  const l3=document.getElementById('l3').value;
  const l4=document.getElementById('l4').value;
  const l5=document.getElementById('l5').value;

  const yStart=parseInt(document.getElementById('yStart').value);
  const yStep=parseInt(document.getElementById('yStep').value);
  const xLeft=parseInt(document.getElementById('xLeft').value);
  const dir=parseInt(document.getElementById('direction').value);

  let y=yStart;

  let cmd='';
  cmd+='SIZE 40 mm,30 mm\r\n';
  cmd+='GAP 2 mm,0 mm\r\n';
  cmd+=`DIRECTION ${dir}\r\n`;
  cmd+='REFERENCE 0,0\r\n';
  cmd+='CLS\r\n';

  // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∫—Ä—É–ø–Ω–µ–µ (—à—Ä–∏—Ñ—Ç "4")
  if(l1){
    cmd+=`TEXT ${xLeft},${y},"4",0,1,1,"${l1}"\r\n`;
    y+=yStep+10; // –¥–ª—è –∫—Ä—É–ø–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞ –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø
  }
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–ª—å—á–µ (—à—Ä–∏—Ñ—Ç "3")
  if(l2){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l2}"\r\n`;
    y+=yStep;
  }
  if(l3){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l3}"\r\n`;
    y+=yStep;
  }
  if(l4){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l4}"\r\n`;
    y+=yStep;
  }
  if(l5){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l5}"\r\n`;
  }

  cmd+='PRINT 1,1\r\n';
  return cmd;
}

// --- USB connect ---
async function connectUSB(){
  if(!navigator.usb){
    alert('‚ùå WebUSB —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Chrome/Edge');
    return;
  }
  try{
    usbDevice=await navigator.usb.requestDevice({
      filters:[
        {vendorId:0x0416},
        {vendorId:0x1FC9},
        {classCode:7}
      ]
    });
    await usbDevice.open();
    if(usbDevice.configuration===null){
      await usbDevice.selectConfiguration(1);
    }
    const iface=usbDevice.configuration.interfaces[0];
    await usbDevice.claimInterface(iface.interfaceNumber);
    const outEp=iface.alternate.endpoints.find(e=>e.direction==='out');
    if(outEp) usbEndpoint=outEp.endpointNumber;
    
    document.getElementById('usbStatus').textContent='üü¢ USB: –ø–æ–¥–∫–ª—é—á–µ–Ω '+(usbDevice.productName||'');
    document.getElementById('usbPrintBtn').disabled=false;
    document.getElementById('usbConnectBtn').disabled=true;
    document.getElementById('usbDisconnectBtn').disabled=false;
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ USB: '+e.message);
  }
}

// --- USB disconnect ---
async function disconnectUSB(){
  if(!usbDevice) return;
  try{
    await usbDevice.close();
    usbDevice=null;
    
    document.getElementById('usbStatus').textContent='üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
    document.getElementById('usbPrintBtn').disabled=true;
    document.getElementById('usbConnectBtn').disabled=false;
    document.getElementById('usbDisconnectBtn').disabled=true;
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: '+e.message);
  }
}

async function printUSB(){
  if(!usbDevice){
    alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–Ω—Ç–µ—Ä');
    return;
  }
  const cmd=buildTSPL();
  console.log('TSPL –∫–æ–º–∞–Ω–¥–∞:\n'+cmd);
  
  // –°—Ç—Ä–æ–≥–æ ASCII
  const bytes=new Uint8Array(cmd.length);
  for(let i=0;i<cmd.length;i++){
    bytes[i]=cmd.charCodeAt(i)&0xFF;
  }
  try{
    await usbDevice.transferOut(usbEndpoint,bytes);
    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä!');
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: '+e.message);
  }
}

// --- PDF 40√ó30 landscape ---
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({
    orientation:'landscape',
    unit:'mm',
    format:[40,30]
  });
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const img=canvas.toDataURL('image/png');
  pdf.addImage(img,'PNG',0,0,40,30);
  pdf.save('birka.pdf');
}

// --- PNG ---
async function exportPNG(){
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='birka.png';
  a.click();
}

// --- Browser print ---
function browserPrint(){
  const f1=12,f2=10,lh=1.2,pt=0.5;
  const label={
    line1:document.getElementById('l1').value,
    line2:document.getElementById('l2').value,
    line3:document.getElementById('l3').value,
    line4:document.getElementById('l4').value,
    line5:document.getElementById('l5').value
  };
  const html=`
    <div class="print-label" style="padding-top:${pt}mm;line-height:${lh}">
      <div style="font-size:${f1}pt;font-weight:bold">${label.line1||''}</div>
      <div style="font-size:${f2}pt">${label.line2||''}</div>
      <div style="font-size:${f2}pt">${label.line3||''}</div>
      <div style="font-size:${f2}pt">${label.line4||''}</div>
      <div style="font-size:${f2}pt">${label.line5||''}</div>
    </div>`;
  document.getElementById('printArea').innerHTML=html;
  setTimeout(()=>window.print(),200);
}

// events
document.getElementById('usbConnectBtn').addEventListener('click',connectUSB);
document.getElementById('usbDisconnectBtn').addEventListener('click',disconnectUSB);
document.getElementById('usbPrintBtn').addEventListener('click',printUSB);
document.getElementById('pdfBtn').addEventListener('click',exportPDF);
document.getElementById('pngBtn').addEventListener('click',exportPNG);
document.getElementById('printBtn').addEventListener('click',browserPrint);
</script>
</body>
</html>
