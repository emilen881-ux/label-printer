<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ë–∏—Ä–∫–∏ USB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:Arial,sans-serif;
      background:#f5f5f5;
      padding:20px;
    }
    .container{
      max-width:400px;
      margin:0 auto;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    h1{
      font-size:18px;
      margin-bottom:16px;
      color:#333;
    }
    .preview{
      width:151px;
      height:113px;
      border:2px solid #000;
      background:white;
      margin:0 auto 20px;
      position:relative;
      overflow:hidden;
    }
    .line{
      position:absolute;
      width:100%;
      text-align:center;
      font-family:Arial,sans-serif;
    }
    input[type="text"]{
      width:100%;
      padding:8px;
      margin-bottom:8px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:14px;
    }
    .btn{
      width:100%;
      padding:12px;
      margin-bottom:8px;
      border:none;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      color:white;
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed;}
    .btn-connect{background:#10b981;}
    .btn-disconnect{background:#f59e0b;}
    .btn-print{background:#ec4899;}
    .status{
      padding:10px;
      margin-bottom:12px;
      background:#f0f0f0;
      border-radius:6px;
      font-size:13px;
      text-align:center;
      font-weight:600;
    }
    .hint{
      font-size:12px;
      color:#666;
      padding:10px;
      background:#dcfce7;
      border-radius:6px;
      margin-bottom:12px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üè∑Ô∏è –ü–µ—á–∞—Ç—å –±–∏—Ä–æ–∫ USB</h1>
  
  <div class="hint">
    ‚úÖ –ü–µ—á–∞—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞. –ß—Ç–æ –≤–∏–¥–∏—à—å ‚Äî —Ç–æ –∏ –±—É–¥–µ—Ç!
  </div>

  <div class="preview" id="preview">
    <div class="line" id="l1" style="top:15px;font-size:14pt;font-weight:bold"></div>
    <div class="line" id="l2" style="top:40px;font-size:11pt"></div>
    <div class="line" id="l3" style="top:60px;font-size:11pt"></div>
    <div class="line" id="l4" style="top:80px;font-size:11pt"></div>
    <div class="line" id="l5" style="top:100px;font-size:11pt"></div>
  </div>

  <input id="i1" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 1" value="1–†–ü3-–ì—Ä.-3.1">
  <input id="i2" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 2" value="–û—Å–≤–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—â–∏—Ç–æ–≤–æ–π">
  <input id="i3" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 3" value="–í–í–ì–Ω–≥(–ê)-LSLTx 3√ó1.5">
  <input id="i4" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 4" value="–æ—Ç 1–†–ü3">
  <input id="i5" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 5" value="L=15–º">

  <div class="status" id="status">üî¥ USB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

  <button class="btn btn-connect" id="connectBtn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
  <button class="btn btn-disconnect" id="disconnectBtn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å</button>
  <button class="btn btn-print" id="printBtn" disabled>‚ö° –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ USB</button>
</div>

<canvas id="canvas"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let device=null;
let endpoint=1;

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function update(){
  for(let i=1;i<=5;i++){
    document.getElementById('l'+i).textContent=document.getElementById('i'+i).value;
  }
}
['i1','i2','i3','i4','i5'].forEach(id=>document.getElementById(id).addEventListener('input',update));
update();

// USB –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
async function connect(){
  if(!navigator.usb){alert('‚ùå –¢–æ–ª—å–∫–æ Chrome/Edge');return;}
  try{
    device=await navigator.usb.requestDevice({filters:[{classCode:7}]});
    await device.open();
    if(!device.configuration) await device.selectConfiguration(1);
    await device.claimInterface(0);
    const ep=device.configuration.interfaces[0].alternate.endpoints.find(e=>e.direction==='out');
    if(ep) endpoint=ep.endpointNumber;
    
    document.getElementById('status').textContent='üü¢ '+(device.productName||'–ü–æ–¥–∫–ª—é—á–µ–Ω');
    document.getElementById('connectBtn').disabled=true;
    document.getElementById('disconnectBtn').disabled=false;
    document.getElementById('printBtn').disabled=false;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

async function disconnect(){
  if(!device) return;
  try{
    await device.close();
    device=null;
    document.getElementById('status').textContent='üî¥ USB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
    document.getElementById('connectBtn').disabled=false;
    document.getElementById('disconnectBtn').disabled=true;
    document.getElementById('printBtn').disabled=true;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è canvas –≤ –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–π bitmap –¥–ª—è TSPL
async function printUSB(){
  if(!device){alert('‚ùå –ü–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–Ω—Ç–µ—Ä');return;}
  
  try{
    // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–µ–≤—å—é –≤ canvas
    const canvas=await html2canvas(document.getElementById('preview'),{
      scale:2,
      backgroundColor:'#ffffff'
    });
    
    const ctx=canvas.getContext('2d');
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const pixels=imgData.data;
    
    const w=canvas.width;
    const h=canvas.height;
    const bytesPerRow=Math.ceil(w/8);
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–π bitmap (–∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: 0=—á–µ—Ä–Ω—ã–π, 1=–±–µ–ª—ã–π)
    const bitmapBytes=[];
    for(let y=0;y<h;y++){
      let bits='';
      for(let x=0;x<w;x++){
        const i=(y*w+x)*4;
        const brightness=(pixels[i]+pixels[i+1]+pixels[i+2])/3;
        bits+=brightness<128?'0':'1';  // ‚Üê –ò–ó–ú–ï–ù–ï–ù–û: –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏
      }
      // –î–æ–ø–æ–ª–Ω—è–µ–º –¥–æ –∫—Ä–∞—Ç–Ω–æ—Å—Ç–∏ 8
      while(bits.length%8!==0) bits+='1';  // ‚Üê –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –±–∞–π—Ç—ã
      for(let i=0;i<bits.length;i+=8){
        const byte=parseInt(bits.substring(i,i+8),2);
        bitmapBytes.push(byte);
      }
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º TSPL –∫–æ–º–∞–Ω–¥—É
    let cmd='';
    cmd+='SIZE 40 mm,30 mm\r\n';
    cmd+='GAP 2 mm,0 mm\r\n';
    cmd+='DIRECTION 1\r\n';
    cmd+='CLS\r\n';
    cmd+=`BITMAP 0,0,${bytesPerRow},${h},1,`;
    
    // ASCII —á–∞—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã
    const cmdBytes=[];
    for(let i=0;i<cmd.length;i++){
      cmdBytes.push(cmd.charCodeAt(i));
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º bitmap –¥–∞–Ω–Ω—ã–µ
    cmdBytes.push(...bitmapBytes);
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    const footer='\r\nPRINT 1,1\r\n';
    for(let i=0;i<footer.length;i++){
      cmdBytes.push(footer.charCodeAt(i));
    }
    
    const data=new Uint8Array(cmdBytes);
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞–π—Ç–æ–≤:',data.length);
    console.log('–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:',w,'x',h,'–ø–∏–∫—Å–µ–ª–µ–π');
    
    await device.transferOut(endpoint,data);
    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä!');
    
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞: '+e.message);
  }
}

// –°–æ–±—ã—Ç–∏—è
document.getElementById('connectBtn').addEventListener('click',connect);
document.getElementById('disconnectBtn').addEventListener('click',disconnect);
document.getElementById('printBtn').addEventListener('click',printUSB);
</script>
</body>
</html>
